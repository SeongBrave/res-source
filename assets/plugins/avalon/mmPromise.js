!function(){function a(a){return a}function b(a){throw a}function c(a){return this.then(a,b)}function d(b){return this.then(a,b)}function e(){var a={};return a.promise=new this(function(b,c){a.resolve=b,a.reject=c}),a}function g(a,b){if("boolean"==typeof a.async)var c=a.async;else c=a.async=!0;c?window.setTimeout(b,0):b()}function i(a,b){if("pending"===a._state)if(b&&"function"==typeof b.then){var c=b instanceof f?"_then":"then";b[c](function(b){k(a,b,!0)},function(b){k(a,b,!1)})}else k(a,b,!0)}function j(a,b){"pending"===a._state&&k(a,b,!1)}function k(a,b,c){a._fired=!0,a._value=b,a._state=c?"fulfilled":"rejected",g(a,function(){a._callbacks.forEach(function(b){a._fire(b.onSuccess,b.onFail)})})}function l(a,b){b=Array.isArray(b)?b:[];var e,c=0,d=[];return new f(function(f,g){function h(h,i){h.then(function(g){e||(d[i]=g,c++,(a||c>=b.length)&&(f(a?g:d),e=!0))},function(a){e=!0,g(a)})}b.length||f(d);for(var i=0,j=b.length;j>i;i++)h(b[i],i)})}var h,m,f=function(a){this._callbacks=[];var b=this;if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");a(function(a){i(b,a)},function(a){j(b,a)})};return f.resolve=function(a){return new f(function(b){b(a)})},f.reject=function(a){return new f(function(b,c){c(a)})},f.prototype={constructor:f,_state:"pending",_fired:!1,_fire:function(a,b){if("rejected"===this._state){if("function"!=typeof b)throw this._value;b(this._value)}else"function"==typeof a&&a(this._value)},_then:function(a,b){if(this._fired){var c=this;g(c,function(){c._fire(a,b)})}else this._callbacks.push({onSuccess:a,onFail:b})},then:function(c,d){var e,g,i;c="function"==typeof c?c:a,d="function"==typeof d?d:b,e=this,g=new f(function(a,b){e._then(function(d){try{d=c(d)}catch(e){return b(e),void 0}a(d)},function(c){try{c=d(c)}catch(e){return b(e),void 0}a(c)})});for(i in e)h[i]||(g[i]=e[i]);return g},done:c,"catch":d,fail:d},h={_state:1,_fired:1,_value:1,_callbacks:1},f.all=function(a){return l(!1,a)},f.race=function(a){return l(!0,a)},f.defer=e,avalon.Promise=f,m=window.Promise,/native code/.test(m)&&(m.prototype.done=c,m.prototype.fail=d,m.defer||(m.defer=e)),window.Promise=m||f}();